init_elemental_water_spells_effect = {
    add_to_global_variable_list = { name = elemental_water_spells target = flag:summon_water_elemental }
    add_to_global_variable_list = { name = elemental_water_spells target = flag:soothing_waters }
    add_to_global_variable_list = { name = elemental_water_spells target = flag:river_spirits_rage }
    add_to_global_variable_list = { name = elemental_water_spells target = flag:invoke_tsunami }
    add_to_global_variable_list = { name = elemental_water_spells target = flag:frost_shock }
    add_to_global_variable_list = { name = elemental_water_spells target = flag:icefury }
    add_to_global_variable_list = { name = elemental_water_spells target = flag:ice_structure }
    add_to_global_variable_list = { name = elemental_water_spells target = flag:eternal_winter }
}

add_or_increase_frostbite_effect = {
    if = {
        limit = {
            has_trait_rank = {
                trait = frostbite
                rank < 3
            }
        }
        change_trait_rank = { trait = frostbite rank = 1 max = 3 }
    }
    else_if = { #Using an if because this needs to never go wrong
        limit = {
            has_trait_rank = {
                trait = frostbite
                rank = 3
            }
        }
        if = {
            limit = {
                NOT = { $CASTER$ = none }
            }
            override_death_killer_effect = {
                death_reason = death_frostbite_magic
                killer = $CASTER$
            }
        }
    }
}

cast_summon_water_elemental_effect = {
    if = {
        limit = { exists = var:summon_water_elemental_recipient }

        if = {
            limit = {
                exists = var:summon_water_elemental_original_recipient
            }

            var:summon_water_elemental_original_recipient = {
                save_scope_as = character_recipient
            }
            var:summon_water_elemental_recipient = {
                save_scope_as = title_recipient
            }
        }
        else = {
            var:summon_water_elemental_recipient = {
                save_temporary_scope_as = character_recipient
            }
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:summon_water_elemental
            exists = var:spellbook_open
            exists = var:spell_recipient
        }

        if = {
            limit = {
                exists = var:original_recipient
            }

            var:original_recipient = {
                save_scope_as = character_recipient
            }
            var:spell_recipient = {
                save_scope_as = title_recipient
            }
        }
        else = {
            var:spell_recipient = {
                save_temporary_scope_as = character_recipient
            }
        }
    }

    if = {
        limit = {
            exists = scope:character_recipient
            OR = { # current_spell_rank is for tooltips
                AND = {
                    exists = var:summon_water_elemental_rank
                    var:summon_water_elemental_rank >= 1
                }
                AND = {
                    exists = var:current_spell_rank
                    var:current_spell_rank >= 1
                }
            }
        }

        root = {
            save_temporary_scope_value_as = {
                name = duration
                value = wc_spell_summon_water_elemental_duration_days_value
            }
        }
        scope:character_recipient = {
            add_character_modifier = {
                modifier = wc_summon_water_elemental_modifier
                days = wc_current_spell_duration
            }
        }

        if = {
            limit = {
                OR = {
                    AND = {
                        exists = var:summon_water_elemental_rank
                        var:summon_water_elemental_rank >= 2
                    }
                    AND = {
                        exists = var:current_spell_rank
                        var:current_spell_rank >= 2
                    }
                }
            }
            scope:character_recipient = {
                add_character_flag = {
                    flag = has_water_elemental_maa
                    days = 735
                }

                spawn_army = {
                    uses_supply = no
                    inheritable = yes
                    name = summoned_water_elemental
                    men_at_arms = {
                        type = water_elemental
                        stacks = 1
                    }
                    location = scope:title_recipient.title_province
                }
            }
            if = {
                limit = {
                    OR = {
                        AND = {
                            exists = var:summon_water_elemental_rank
                            var:summon_water_elemental_rank = 3
                        }
                        AND = {
                            exists = var:current_spell_rank
                            var:current_spell_rank = 3
                        }
                    }
                }

                scope:character_recipient = {
                    add_character_modifier = {
                        modifier = wc_empowered_water_elemental_modifier
                        days = wc_current_spell_duration
                    }
                }
            }
        }
    }
}

cast_soothing_waters_effect = {
    if = {
        limit = { exists = var:soothing_waters_recipient }
        var:soothing_waters_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:soothing_waters
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        root = {
            save_temporary_scope_value_as = {
                name = duration
                value = wc_spell_soothing_waters_duration_days_value
            }
        }
        add_character_modifier = {
            modifier = wc_soothing_waters_modifier
            days = wc_current_spell_duration
        }
    }
}

cast_river_spirits_rage_effect = {
    if = {
        limit = { exists = var:river_spirits_rage_recipient }
        var:river_spirits_rage_recipient = {
            save_temporary_scope_as = this_recipient
        }
        var:river_spirits_rage_rank = {
            save_temporary_scope_as = this_rank
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:river_spirits_rage
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
        var:current_spell_rank = {
            save_temporary_scope_as = this_rank
        }
    }

    scope:this_recipient ?= {
        if = {
            limit = {
                exists = scope:this_rank
                scope:this_rank < 3
            }

            root = {
                save_temporary_scope_value_as = {
                    name = duration
                    value = wc_spell_river_spirits_rage_duration_days_value
                }
            }
            add_character_modifier = {
                modifier = wc_river_spirits_rage_character_modifier
                days = wc_current_spell_duration
            }

            if = {
                limit = {
                    root = {
                        has_perk = elemental_water_magic_tree_1_perk_7
                    }
                }
                add_character_modifier = {
                    modifier = wc_sirens_call_modifier
                    days = wc_current_spell_duration
                }
            }
        }

        if = {
            limit = {
                exists = scope:this_rank
                scope:this_rank = 2
            }

            root = {
                save_temporary_scope_value_as = {
                    name = duration
                    value = wc_spell_river_spirits_rage_duration_days_value
                }
            }
            add_character_modifier = {
                modifier = wc_river_spirits_rage_character_modifier
                days = wc_current_spell_duration
            }
        }

        if = {
            limit = {
                exists = scope:this_rank
                scope:this_rank = 3
            }

            root = {
                save_temporary_scope_value_as = {
                    name = duration
                    value = wc_spell_river_spirits_rage_duration_days_value
                }
            }
            army_commander = {
                add_character_modifier = {
                    modifier = wc_river_spirits_rage_army_modifier
                    days = wc_current_spell_duration
                }
            }
            set_variable = {
                name = river_spirits_rage_remainder
                days = wc_current_spell_duration
            }
        }
    }
}

cast_invoke_tsunami_effect = {
    if = {
        limit = { exists = var:invoke_tsunami_recipient }
        var:invoke_tsunami_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:invoke_tsunami
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient.title_province ?= {
        root = {
            save_temporary_scope_value_as = {
                name = duration
                value = wc_spell_invoke_tsunami_duration_days_value
            }
        }
        add_to_list = targets
        invoke_tsunami_select_targets = yes

        every_in_list = {
            list = targets

            county = {
                add_to_list = target_counties
            }

            add_province_modifier = {
                modifier = wc_invoke_tsunami_modifier
                days = wc_current_spell_duration
            }
        }

        every_in_list = {
            list = target_counties

            change_development_level = {
                value = -3
            }
        }
    }
}

invoke_tsunami_select_targets = {
    every_neighboring_province = {
        limit = {
            exists = county
            is_sea_province = no
            is_coastal = yes
            NOT = {
                is_in_list = targets
            }
        }

        if = {
            limit = {
                list_size:targets < 5
            }
            add_to_list = targets

            invoke_tsunami_select_targets = yes
        }
    }
}

cast_frost_shock_effect = {
    if = {
        limit = { exists = var:frost_shock_recipient }
        var:frost_shock_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:frost_shock
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        add_or_increase_frostbite_effect = { CASTER = root }
    }
}

cast_icefury_effect = {
    if = {
        limit = { exists = var:icefury_recipient }
        var:icefury_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:icefury
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        root = {
            save_temporary_scope_value_as = {
                name = duration
                value = wc_spell_icefury_duration_days_value
            }
        }

        every_de_jure_county = {
            add_county_modifier = {
                modifier = wc_icefury_modifier
                days = wc_current_spell_duration
            }
            add_to_list = counties
        }
        every_in_list = {
            list = counties
            every_county_province = {
                every_character_in_location = {
                    limit = {
                        has_trait = frostbite
                    }
                    random_list = {
                        20 = {
                            increase_wounds_effect = { REASON = magic }
                        }
                        80 = { }
                    }
                }
            }
        }
    }
}

cast_ice_structure_effect = {
    if = {
        limit = { exists = var:ice_structure_recipient exists = var:ice_structure_type }
        var:ice_structure_recipient = {
            save_temporary_scope_as = this_recipient
        }
        var:ice_structure_type = {
            save_scope_as = this_spell_type
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:ice_structure
            exists = var:spellbook_open
            exists = var:spell_recipient
            exists = var:elemental_type
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
        var:elemental_type = {
            save_scope_as = this_spell_type
        }
    }

    scope:this_recipient.title_province ?= {
        root = {
            save_temporary_scope_value_as = {
                name = duration
                value = wc_spell_ice_structure_duration_days_value
            }
        }

        if = {
            limit = {
                scope:this_spell_type ?= flag:spirit
            }
            add_province_modifier = {
                modifier = wc_ice_structure_spirit_province_modifier
                days = wc_current_spell_duration
            }

            hidden_effect = {
                every_character_in_location = {
                    limit = {
                        NOT = {
                            has_character_modifier = wc_ice_structure_spirit_character_modifier
                        }
                    }
                    apply_character_ice_structure_effect = { TYPE = spirit }
                }

                trigger_event = {
                    on_action = wc_ice_structure_province_pulse
                    months = 1
                }
            }
        }
        else_if = {
            limit = {
                scope:this_spell_type ?= flag:decay
            }
            add_province_modifier = {
                modifier = wc_ice_structure_decay_province_modifier
                days = wc_current_spell_duration
            }

            hidden_effect = {
                every_character_in_location = {
                    limit = {
                        NOT = {
                            has_character_modifier = wc_ice_structure_decay_character_modifier
                        }
                    }
                    apply_character_ice_structure_effect = { TYPE = decay }
                }

                trigger_event = {
                    on_action = wc_ice_structure_province_pulse
                    months = 1
                }
            }
        }
    }
}

apply_character_ice_structure_effect = {
    if = {
        limit = {
            NOT = {
                has_character_modifier = wc_ice_structure_$TYPE$_character_modifier
            }
        }
        add_character_modifier = {
            modifier = wc_ice_structure_$TYPE$_character_modifier
        }

        trigger_event = {
            on_action = wc_ice_structure_removal_pulse
            months = 1
        }
    }
}

cast_eternal_winter_effect = {
    if = {
        limit = { exists = var:eternal_winter_recipient }
        var:eternal_winter_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }
    else_if = {
        limit = {
            exists = var:current_spell_name
            var:current_spell_name = flag:eternal_winter
            exists = var:spellbook_open
            exists = var:spell_recipient
        }
        var:spell_recipient = {
            save_temporary_scope_as = this_recipient
        }
    }

    scope:this_recipient ?= {
        root = {
            save_temporary_scope_value_as = {
                name = duration
                value = wc_spell_eternal_winter_duration_days_value
            }
        }
        add_to_list = targets
        eternal_winter_select_targets = yes

        every_in_list = {
            list = targets

            save_scope_as = duchy

            kingdom ?= {
                add_to_list = target_kingdoms
            }

            custom_tooltip = {
                text = wc_eternal_winter_effect
                every_de_jure_county = {
                    add_county_modifier = {
                        modifier = wc_eternal_winter_modifier
                        days = wc_current_spell_duration
                    }
                }
            }

            trigger_event = {
                on_action = wc_eternal_winter_duchy_pulse
            }
        }

        root = {
            add_character_modifier = {
                modifier = wc_eternal_winter_renown_modifier
                days = wc_current_spell_duration
            }
            add_character_modifier = {
                modifier = wc_eternal_winter_gold_modifier
                days = wc_current_spell_duration
            }
        }
    }
}

eternal_winter_select_targets = {
    every_title_to_title_neighboring_duchy = {
        limit = {
            NOT = {
                is_in_list = targets
            }
        }

        if = {
            limit = {
                list_size:targets < 3
            }
            add_to_list = targets

            eternal_winter_select_targets = yes
        }
    }

    # For titles without any de jure counties we have to base it on their capital county's de jure duchy
    if = {
        limit = {
            any_title_to_title_neighboring_duchy = {
                count = 0
            }
            list_size:targets < 3
            NOT = {
                this = title_capital_county.duchy
            }
            title_capital_county.duchy ?= {
                NOT = {
                    is_in_list = targets
                }
            }
        }

        remove_from_list = targets

        title_capital_county.duchy ?= {
            add_to_list = targets

            eternal_winter_select_targets = yes
        }
    }
}