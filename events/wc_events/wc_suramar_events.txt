namespace = wc_suramar_events
### SURAMAR EVENTS ###
# 0001 - Opening event
# 0002 - You learn about the world beyond Suramar
# 0003 - You learn about the nightfallen
# 0010 - Someone informs you of mysterious happenings in the aqeducts
# 0011-0012 - Investigate the aqeducts


scripted_trigger is_eligible_for_suramar_events_trigger = {
    exists = title:k_suramar.holder
    is_in_suramar_trigger = yes
    is_available_adult = yes
    is_landed = yes
}

scripted_effect suramar_exile_character_effect = {
    $EXILED$ = { save_scope_as = exiled_character }
    custom_tooltip = suramar_exile_character_effect_tt
    scope:exiled_character = {
        add_opinion = {
            modifier = exiled_opinion
            target = root
        }
        banish = yes 
    }
    add_to_variable_list = {
        list = suramar_exiled_characters
        target = scope:exiled_character
    }
}

scripted_effect suramar_discover_outside_world_effect = {

    trigger_event = {
        id = wc_suramar_events.0002
        days = { 1 10 }
    }
}

scripted_effect suramar_discover_nightfallen_effect = {
    #custom_tooltip = suramar_discover_nightfallen_effect_tt
    add_character_flag = had_nightfallen_event
    # event 
}

# Opening event for the leader of Suramar if barrier is up
wc_suramar_events.0001 = {
    type = character_event
	content_source = dlc_GOA
    title = wc_suramar_events.0001.t
	desc = wc_suramar_events.0001.d
	theme = realm

    trigger = {
        root = { has_title = title:k_suramar }
        NOT = { has_global_variable = suramar_barrier_lowered_variable }
    }

    left_portrait = {
        character = root
        animation = personality_honorable
    }

    immediate = {
        custom_tooltip = {
            text = wc_suramar_events.0001_tt
            every_sub_realm_county = {
                add_county_modifier = {
                    modifier = wc_suramar_isolated_modifier
                }
            }
        }
    }

    # Focus on building the region 
    option = {
        name = wc_suramar_events.001.a
        capital_county = {
            add_county_modifier = {
                modifier = wc_suramar_city_modifier
                years = 5
            }
        }
    }

    # Focus on my expanding my power
    option = {
        name = wc_suramar_events.001.b
        add_character_modifier = {
            modifier = wc_suramar_ruler_modifier
            years = 5
        }
    }
}

# You learn about the world outside of suramar
wc_suramar_events.0002 = {
    type = character_event
	content_source = dlc_GOA
    title = wc_suramar_events.0002.t
	desc = wc_suramar_events.0002.desc
	theme = realm

    override_background = { reference = study }

    left_portrait = {
        character = root
        animation = stress
    }

    # You gain the decision
    option = {
        name = wc_suramar_events.0002.a
        trigger = {
            has_title = title:k_suramar
        }
        save_scope_as = suramar_ruler
        add_character_flag = had_outsider_event
        custom_tooltip = suramar_discover_outside_world_effect_tt
    }

    # Your liege gains the decision
    option = {
        name = wc_suramar_events.0002.b
        trigger = {
            NOT = { has_title = title:k_suramar }
        }
        title:k_suramar.holder = { 
            save_scope_as = suramar_ruler
        }
        scope:suramar_ruler = { add_character_flag = had_outsider_event }
        custom_tooltip = suramar_discover_outside_world_effect_tt
    }
}

wc_suramar_events.0010 = {
    type = character_event
	content_source = dlc_GOA
    title = wc_suramar_events.0010.t
	desc = {
        desc = wc_suramar_events.0010.d
        first_valid = {
            triggered_desc = {
                trigger = {
                    has_title = title:k_suramar
                    location.county = title:c_suramar
                }
                desc = wc_suramar_events.0010.desc_nightwell
            }
            desc = wc_suramar_events.0010.desc_ruler
        }
    }
	theme = realm

    override_background = { reference = courtyard }

    cooldown = { years = 1 }

    trigger = {
        NOT = { has_character_flag = suramar_vaults_cleared }
        is_eligible_for_suramar_events_trigger = yes
        any_courtier = { count >= 1 }
    }

    left_portrait = {
        character = root
        animation = thinking
    }

    right_portrait = {
        character = scope:informant
        animation = stress
    }

    immediate = {
        location = {
            save_scope_as = location_scope
        }
        random_courtier = {
            save_scope_as = informant
        }
    }

    # I will investigate this!
    option = {
        name = wc_suramar_events.0010.a
        custom_tooltip = wc_suramar_events.0010.a_tt
        save_scope_as = investigator

        trigger_event = wc_suramar_events.0011

        stress_impact = {
            diligent = minor_stress_impact_loss
            brave = minor_stress_impact_loss
            craven = minor_stress_impact_gain
        }

        ai_chance = {
            base = 100
            ai_value_modifier = {
                ai_energy = 1
                ai_rationality = 1
            }
        }
    }

    # Send an knight to investigate
    option = {
        name = wc_suramar_events.0010.b
        trigger = {
            any_knight = { count >= 1 }
            short_term_gold >= minor_gold_value
        }
        ordered_knight = {
            order_by = prowess
            save_scope_as = investigator
            
            custom_tooltip = wc_suramar_events.0010.b_tt
        }
        pay_short_term_gold = {
            target = scope:investigator
            gold = minor_gold_value
        }
        trigger_event = wc_suramar_events.0011

        stress_impact = {
            greedy = minor_stress_impact_gain
        }

        ai_chance = {
            base = 100
            ai_value_modifier = {
                ai_greed = -1
                ai_rationality = 1
            }
        }
    }

    # Ignore it
    option = {
        name = wc_suramar_events.0010.c

        random = {
            chance = 50
            send_interface_toast = {
                title = wc_suramar_events.0010.c_bad
                type = event_toast_effect_bad
                left_icon = root
                right_icon = scope:informant
                location.county = {
                    add_county_modifier = {
                        modifier = wc_suramar_vaults_bad_modifier
                        years = 3
                    }
                }
            }
        }

        stress_impact = {
            lazy = minor_stress_impact_loss
            craven = minor_stress_impact_loss
        }

        scope:informant = {
            add_opinion = {
				modifier = disappointed_opinion
				target = root
				opinion = -15
			}  
        }

        ai_chance = {
            base = 25
            modifier = {
                factor = 0
                OR = {
                    has_trait = paranoid
                    has_trait = just
                }
            }
        }
    }
}

wc_suramar_events.0011 = {
    type = character_event
	content_source = dlc_GOA
    title = wc_suramar_events.0010.t
	desc = {
        first_valid = {
            triggered_desc = {
                trigger = {
                    has_title = title:k_suramar
                    location.county = title:c_suramar
                }
                desc = wc_suramar_events.0011.desc_nightwell
            }
            desc = wc_suramar_events.0011.desc_ruler
        }
        first_valid = {
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:dog
                }
                desc = wc_suramar_events.0011.desc_dog
            }
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:cat
                }
                desc = wc_suramar_events.0011.desc_cat
            }
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:nightfallen
                }
                desc = wc_suramar_events.0011.desc_nightfallen
            }
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:monster
                }
                desc = wc_suramar_events.0011.desc_monster
            }
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:bandit
                }
                desc = wc_suramar_events.0011.desc_bandit
            }
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:outsider
                }
                desc = wc_suramar_events.0011.desc_outsider
            }
        }
    }
	theme = martial

    override_background = { reference = suramar_arcway }

    left_portrait = {
        character = scope:investigator
        animation = aggressive_sword
    }

    immediate = {
        set_variable = {
            name = investigator_var
            value = scope:investigator
        }
        # Actually determine what the disturbance is
        random_list = {
            5 = {
                trigger = {
                    NOT = { has_dog_trigger = yes }
                }
                set_variable = { name = suramar_disturbance value = flag:dog }
            }
            5 = {
                trigger = {
                    NOT = { has_cat_trigger = yes }
                }
                set_variable = { name = suramar_disturbance value = flag:cat }
            }
            20 = {
                set_variable = { name = suramar_disturbance value = flag:monster }
            }
            # 20 = {
            #     set_variable = { name = suramar_disturbance value = flag:nightfallen }
            # }
            20 = {
                set_variable = { name = suramar_disturbance value = flag:bandit }
            }
            10 = {
                modifier = {
                    add = 5
                    NOT = { has_character_flag = had_outsider_event }
                }
                set_variable = { name = suramar_disturbance value = flag:outsider }
            }
        }
    }

    # Option if investigator is not you
    option = {
        name = wc_suramar_events.0011.a
        trigger = {
            NOT = { scope:investigator = root }
        }
        duel = {
            skill = intrigue
            value = decent_skill_rating
            80 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = 3.5
				}
                save_scope_value_as = { name = suramar_investigation_result value = flag:won }
                custom_tooltip = wc_suramar_events.0011.knight_success
            }
            30 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = -3.5
				}
                save_scope_value_as = { name = suramar_investigation_result value = flag:lost }
                custom_tooltip = wc_suramar_events.0011.knight_failure
            }
        }
        save_scope_value_as = { name = suramar_investigation_method value = flag:knight }
        trigger_event = wc_suramar_events.0012
    }

    # Hide in the shadows
    option = {
        name = wc_suramar_events.0011.b
        trigger = {
            scope:investigator = root
        }
        duel = {
            desc = wc_suramar_events.0011.b_duel
            skill = intrigue
            value = decent_skill_rating
            70 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = 3.5
				}
                custom_tooltip = wc_suramar_events.0011.success
                save_scope_value_as = { name = suramar_investigation_result value = flag:won }
            }
            35 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = -3.5
				}
                custom_tooltip = wc_suramar_events.0011.failure
                save_scope_value_as = { name = suramar_investigation_result value = flag:lost }
            }
        }
        save_scope_value_as = { name = suramar_investigation_method value = flag:sneaky }
        trigger_event = wc_suramar_events.0012
        ai_chance = {
            base = 50
            modifier = {
                factor = 2
                highest_skill_including_prowess = intrigue
            }
            modifier = {
                factor = 1.5
                intrigue > prowess
            }
        }
    }

    # Bum rush whatever it is 
    option = {
        name = wc_suramar_events.0011.c
        trigger = {
            scope:investigator = root
        }
        duel = {
            desc = wc_suramar_events.0011.c_duel
            skill = prowess
            value = decent_skill_rating
            70 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = 3.5
				}
                save_scope_value_as = { name = suramar_investigation_result value = flag:won }
                custom_tooltip = wc_suramar_events.0011.success
            }
            35 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = -3.5
				}
                custom_tooltip = wc_suramar_events.0011.failure
                save_scope_value_as = { name = suramar_investigation_result value = flag:lost }
            }
        }
        save_scope_value_as = { name = suramar_investigation_method value = flag:attack }
        trigger_event = wc_suramar_events.0012
        ai_chance = {
            base = 50
            modifier = {
                factor = 2
                highest_skill_including_prowess = prowess
            }
            modifier = {
                factor = 1.5
                prowess > intrigue
            }
        }
    }

    # Chicken out and leave
    option = {
        name = wc_suramar_events.0011.d
        custom_tooltip = wc_suramar_events.0011.d_tt
        trigger = {
            scope:investigator = root
        }
        random = {
            chance = 50
            send_interface_toast = {
                title = wc_suramar_events.0010.c_bad
                type = event_toast_effect_bad
                left_icon = root
                right_icon = scope:informant
                location.county = {
                    add_county_modifier = {
                        modifier = wc_suramar_vaults_bad_modifier
                        years = 3
                    }
                }
            }
        }

        stress_impact = {
            lazy = minor_stress_impact_loss
            craven = minor_stress_impact_loss
        }

        ai_chance = {
            base = 5
        }
    }
}

wc_suramar_events.0012 = {
    type = character_event
	content_source = dlc_GOA
    title = wc_suramar_events.0010.t
	desc = {
        # Intro, using the method
        triggered_desc = {
            trigger = {
                scope:suramar_investigation_method = flag:knight
            }
            desc = wc_suramar_events.0112.desc_knight
        }
        triggered_desc = {
            trigger = {
                scope:suramar_investigation_method = flag:sneaky
            }
            desc = wc_suramar_events.0112.desc_sneak
        }
        triggered_desc = {
            trigger = {
                scope:suramar_investigation_method = flag:attack
            }
            desc = wc_suramar_events.0112.desc_attack
        }
        first_valid = {
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:dog
                }
                desc = wc_suramar_events.0112.desc_dog
            }
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:cat
                }
                desc = wc_suramar_events.0112.desc_cat
            }
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:nightfallen
                }
                desc = wc_suramar_events.0112.desc_nightfallen
            }
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:monster
                }
                desc = wc_suramar_events.0112.desc_monster
            }
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:bandit
                }
                desc = wc_suramar_events.0112.desc_bandit
            }
            triggered_desc = {
                trigger = {
                    var:suramar_disturbance = flag:outsider
                }
                desc = wc_suramar_events.0112.desc_outsider
            }
        }
        first_valid = {
            triggered_desc = {
                trigger = {
                    scope:suramar_investigation_method = flag:knight
                    scope:suramar_investigation_result = flag:won
                    NOR = {
                        var:suramar_disturbance = flag:cat
                        var:suramar_disturbance = flag:dog
                    }
                }
                desc = wc_suramar_events.0112.desc_knight_won
            }
            triggered_desc = {
                trigger = {
                    scope:suramar_investigation_method = flag:knight
                    scope:suramar_investigation_result = flag:lost
                    NOR = {
                        var:suramar_disturbance = flag:cat
                        var:suramar_disturbance = flag:dog
                    }
                }
                desc = wc_suramar_events.0112.desc_knight_lost
            }
            triggered_desc = {
                trigger = {
                    scope:suramar_investigation_result = flag:won
                    NOR = {
                        var:suramar_disturbance = flag:cat
                        var:suramar_disturbance = flag:dog
                    }
                }
                desc = wc_suramar_events.0112.desc_won
            }
            triggered_desc = {
                trigger = {
                    scope:suramar_investigation_result = flag:lost
                    NOR = {
                        var:suramar_disturbance = flag:cat
                        var:suramar_disturbance = flag:dog
                    }
                }
                desc = wc_suramar_events.0112.desc_lost
            }
        }
    }
	theme = martial

    override_background = { reference = suramar_arcway }

    left_portrait = {
        character = scope:investigator
        triggered_animation = {
            trigger = {
                scope:suramar_investigation_result = flag:lost
                NOR = {
                    var:suramar_disturbance = flag:cat
                    var:suramar_disturbance = flag:dog
                }
            }
            animation = fear
        }
        triggered_animation = {
            trigger = {
                OR = {
                    var:suramar_disturbance = flag:cat
                    var:suramar_disturbance = flag:dog
                }
            }
            animation = admiration
        }
        animation = aggressive_sword
    }

    right_portrait = {
        trigger = { exists = scope:secondary_character }
        triggered_animation = {
            trigger = {
                scope:suramar_investigation_result = flag:won
            }
            animation = fear
        }
        character = scope:secondary_character
        animation = war_defender
    }

    immediate = {
        if = {
            limit = {
                scope:suramar_investigation_result = flag:won
            }
            add_prestige = medium_prestige_gain
        }
        switch = {
            trigger = var:suramar_disturbance
            flag:bandit = {
                create_character = {
                    template = bandit_character
                    location = root.location
                    culture = root.location.culture
                    faith = root.location.faith
                    trait = gallowsbait
                    random_traits = yes
                    save_scope_as = secondary_character
                    after_creation = {
                        # Warcraft
                        trigger_race_giving_no_gene_effect = yes
                    }
                }
            }
            flag:outsider = {
                create_character = {
                    template = generic_peasant_character
                    location = root.location
                    faith = root.faith
                    random_culture = {
                        culture:lordaeronian = { weight = { base = 1 } }
                        culture:alteraci = { weight = { base = 1 } }
                        culture:dalaranian = { weight = { base = 1 } }
                        culture:vrykul = { weight = { base = 1 } }
                        culture:night_elf = { weight = { base = 1 } }
                        culture:high_elf = { weight = { base = 1 } }
                        culture:satyr = { weight = { base = 1 } }
                    }
                    random_traits = yes
                    save_scope_as = secondary_character
                    after_creation = {
                        # Warcraft
                        trigger_race_giving_no_gene_effect = yes
                        if = {
                            limit = {
                                OR = {
                                    culture = culture:lordaeronian
                                    culture = culture:lordaeronian
                                    culture = culture:alteraci
                                }
                            }
                            random_list = {
                                10 = { set_character_faith = faith:holy_light }
                                10 = { set_character_faith = faith:kirin_torian }
                                1 = { 
                                    trigger = { exists = title:e_scourge } 
                                    set_character_faith = faith:death_god set_culture = culture:scourge
                                    add_trait = being_undead
                                }
                            }
                        }
                        else_if = {
                            limit = {
                                culture = culture:vrykul
                            }
                            random_list = {
                                10 = { set_character_faith = faith:odyn }
                                1 = { 
                                    trigger = { exists = title:e_scourge } 
                                    set_character_faith = faith:helya set_culture = culture:kvaldir
                                    add_trait = being_undead remove_trait = creature_vrykul add_trait = creature_kvaldir
                                }
                            }
                        }
                        else_if = {
                            limit = {
                                culture = culture:night_elf
                            }
                            set_character_faith = faith:kaldorei_religion
                        }
                        else_if = {
                            limit = {
                                culture = culture:high_elf
                            }
                            set_character_faith = faith:cult_of_sunwell
                        }
                        else_if = {
                            limit = {
                                culture = culture:satyr
                            }
                            set_character_faith = faith:burning_legion_religion
                        }
                    }
                }
            }
        }
    }

    # Bandit Options #

    # Exile them (could create wretched)
    option = {
        name = wc_suramar_events.0012.bandit_1
        trigger = {
            var:suramar_disturbance = flag:bandit
            scope:suramar_investigation_result = flag:won
        }
        
        suramar_exile_character_effect = {
            EXILED = scope:secondary_character
        }

        stress_impact = {
            vengeful = minor_stress_impact_gain
            forgiving = minor_stress_impact_loss
        }

        ai_chance = {
            base = 50
            ai_value_modifier = {
                ai_vengefulness = -1
            }
        }
    }

    # Jail them
    option = {
        name = wc_suramar_events.0012.bandit_2
        trigger = {
            var:suramar_disturbance = flag:bandit
            scope:suramar_investigation_result = flag:won
        }

        stress_impact = {
            forgiving = minor_stress_impact_gain
            vengeful = minor_stress_impact_loss
        }

        add_dread = minor_dread_gain
        rightfully_imprison_character_less_verbose_effect = {
            TARGET = scope:secondary_character
            IMPRISONER = root
        }

        ai_chance = {
            base = 50
            ai_value_modifier = {
                ai_vengefulness = 1
            }
        }
    }

    # Monster Options #

    # Study it 
    option = {
        name = wc_suramar_events.0012.monster_1
        trigger = {
            var:suramar_disturbance = flag:monster
            scope:suramar_investigation_result = flag:won
        }
    }

    # Show the body as a warning
    option = {
        name = wc_suramar_events.0012.monster_2
        trigger = {
            var:suramar_disturbance = flag:monster
            scope:suramar_investigation_result = flag:won
        }
    }

    # Outsider Options #
     
    # Offer them a place in Suramar
    option = {
        name = wc_suramar_events.0012.outsider_1
        trigger = {
            var:suramar_disturbance = flag:outsider
            scope:suramar_investigation_result = flag:won
        }
    }

    # Kill them
    option = {
        name = wc_suramar_events.0012.outsider_2
        trigger = {
            var:suramar_disturbance = flag:outsider
            scope:suramar_investigation_result = flag:won
        }
    }

    # Nightfallen Options #

    # Offer them a place in Suramar
    option = {
        name = wc_suramar_events.0012.nightfallen_1
        trigger = {
            var:suramar_disturbance = flag:nightfallen
            scope:suramar_investigation_result = flag:won
            has_character_flag = had_nightfallen_event 
        }
    }

    # Kill them
    option = {
        name = wc_suramar_events.0012.nightfallen_2
        trigger = {
            var:suramar_disturbance = flag:nightfallen
            scope:suramar_investigation_result = flag:won
            has_character_flag = had_nightfallen_event 
        }
    }

    # Get the nightfallen event
    option = {
        name = wc_suramar_events.0012.nightfallen_2
        trigger = {
            var:suramar_disturbance = flag:nightfallen
            NOT = { has_character_flag = had_nightfallen_event }
        }
        suramar_discover_nightfallen_effect = yes
    }

    # Pet Options #

    # Adopt it
    option = {
        name = wc_suramar_events.0012.pet_1
        trigger = {
            OR = {
                var:suramar_disturbance = flag:cat
                var:suramar_disturbance = flag:dog
            }
        }
        if = {
            limit = {
                var:suramar_disturbance = flag:dog
            }
            start_dog_story_cycle_effect = yes
        }
        else_if = {
            limit = {
                var:suramar_disturbance = flag:cat
            }
            start_cat_story_cycle_effect = yes
        }
    }

    # Let it be 
    option = {
        name = wc_suramar_events.0012.pet_2
        trigger = {
            OR = {
                var:suramar_disturbance = flag:cat
                var:suramar_disturbance = flag:dog
            }
        }
        add_stress = minor_stress_loss
    }

    # Lost Options #
    option = {
        name = wc_suramar_events.0012.lost
        trigger = {
            scope:suramar_investigation_result = flag:lost
        }
        if = {
            limit = {
                OR = {
                    var:suramar_disturbance = flag:monster
                    var:suramar_disturbance = flag:bandit
                }
            }
            random = {
                chance = 20
                increase_wounds_effect = { REASON = fight }
            }
        }
    }

    after = {
        if = {
            limit = {
                var:suramar_disturbance = flag:outsider
                NOT = { has_character_flag = had_outsider_event }
            }
            suramar_discover_outside_world_effect = yes
        }
        if = {
            limit = {
                scope:suramar_investigation_result = flag:won
                NOR = {
                    var:suramar_disturbance = flag:dog
                    var:suramar_disturbance = flag:cat
                }
            }
            add_character_flag = suramar_vaults_cleared
        }
        else = {
            custom_tooltip = wc_suramar_events.0012.lost_tt
        }
    }
}